# Run tests and if successfull and on main branch deploy to Render
name: Docker CI 

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main", "dev" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      MONGODB_URI: mongodb://mongo:27017/pokemon_team_builder-dev
      PORT: 4000
      NODE_ENV: production
      IMAGE_TAG: ${{ github.sha }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Prod image
        run: docker buildx build --target production -t pokemon-team-builder-api:${IMAGE_TAG:-latest} .

      - name: Run tests via docker-compose
        # Use same IMAGE_TAG for running tests to keep consistency
        run: IMAGE_TAG=${IMAGE_TAG:-latest} docker compose --profile test up --abort-on-container-exit --exit-code-from test

      - name: Trigger Render deployment on success
        # only trigger deployment when pushing to main branch
        if: success() && github.ref_name == 'main'
        run: curl -X POST ${{ secrets.RENDER_DEPLOYMENT_HOOK }}
        